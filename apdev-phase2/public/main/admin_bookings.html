<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - View Bookings</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lalezar&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: #f9f9f9;
        color: #333;
        line-height: 1.6;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      header {
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
      }

      .logo {
        display: flex;
        align-items: center;
      }

      .logo h1 {
        font-family: "Lalezar", cursive;
        color: #0066cc;
        font-size: 2rem;
        margin-left: 10px;
      }

      .logo i {
        color: #0066cc;
        font-size: 2.2rem;
      }

      .nav-links {
        display: flex;
        list-style: none;
      }

      .nav-links li {
        margin-left: 30px;
      }

      .nav-links a {
        text-decoration: none;
        color: #333;
        font-weight: 600;
        transition: color 0.3s ease;
        font-size: 1rem;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: #0066cc;
      }

      .page-header {
        background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
          url("/api/placeholder/1200/300") no-repeat center center/cover;
        color: #fff;
        text-align: center;
        padding: 120px 0 60px;
        margin-bottom: 50px;
      }

      .page-header h1 {
        font-size: 3rem;
        margin-bottom: 20px;
      }

      .page-header p {
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
      }

      .bookings-container {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 50px;
      }

      .bookings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .bookings-header h2 {
        font-size: 1.8rem;
        color: #333;
      }

      .search-filter {
        display: flex;
        gap: 10px;
      }

      .search-filter input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: "Montserrat", sans-serif;
      }

      .search-filter button {
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-family: "Montserrat", sans-serif;
        font-weight: 600;
        transition: background-color 0.3s ease;
      }

      .search-filter button:hover {
        background-color: #0055aa;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #0066cc;
        color: #fff;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f5f5f5;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 30px;
      }

      .pagination button {
        margin: 0 5px;
        padding: 8px 12px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .pagination button:hover {
        background-color: #f5f5f5;
      }

      .pagination button.active {
        background-color: #0066cc;
        color: white;
        border-color: #0066cc;
      }

      footer {
        background-color: #222;
        color: #fff;
        padding: 30px 0;
        margin-top: 60px;
      }

      .footer-content {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .footer-links {
        display: flex;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .footer-links li {
        margin-right: 20px;
      }

      .footer-links a {
        color: #fff;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .footer-links a:hover {
        color: #ff7734;
      }

      .social-icons a {
        display: inline-block;
        margin-left: 15px;
        color: #fff;
        font-size: 1.2rem;
        transition: color 0.3s ease;
      }

      .social-icons a:hover {
        color: #ff7734;
      }

      .copyright {
        margin-top: 20px;
        color: #aaa;
        font-size: 0.9rem;
        text-align: center;
      }

      .action-btns {
        display: flex;
        gap: 10px;
      }

      .action-btns button {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
      }

      .edit-btn {
        background-color: #ff7734;
        color: white;
      }

      .delete-btn {
        background-color: #e74c3c;
        color: white;
      }

      .action-btns button:hover {
        opacity: 0.9;
      }

      .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-confirmed {
        background-color: #2ecc71;
        color: white;
      }

      .status-pending {
        background-color: #f39c12;
        color: white;
      }

      .status-cancelled {
        background-color: #e74c3c;
        color: white;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          padding: 15px 0;
        }

        .nav-links {
          margin-top: 20px;
        }

        .nav-links li {
          margin: 0 15px;
        }

        .page-header h1 {
          font-size: 2.5rem;
        }

        .bookings-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .search-filter {
          width: 100%;
        }

        .search-filter input {
          flex-grow: 1;
        }

        table {
          display: block;
          overflow-x: auto;
        }

        th,
        td {
          padding: 10px;
        }

        .footer-content {
          flex-direction: column;
          align-items: center;
        }

        .footer-links {
          margin-bottom: 20px;
          justify-content: center;
        }

        .social-icons {
          margin-top: 20px;
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .close-btn {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close-btn:hover {
        color: #000;
      }

      .modal-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .modal-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }

      .modal-form input,
      .modal-form select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        border-top: 1px solid #ddd;
        padding-top: 15px;
      }

      .modal-footer button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .save-btn {
        background-color: #0066cc;
        color: white;
      }

      .cancel-btn {
        background-color: #ddd;
        color: #333;
      }

      .save-btn:hover,
      .cancel-btn:hover {
        opacity: 0.9;
      }

    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <i class="fas fa-hotel"></i>
            <h1>MotelEase</h1>
          </div>
          <ul class="nav-links">
            <li><a href="admin">Home</a></li>
            <li><a href="room-management">Manage Rooms</a></li>
            <!-- <li><a href="amenities_management.html">Manage Amenities</a></li> -->
            <li><a href="admin-bookings" class="active">View Bookings</a></li>
            <li><a href="../index.html">Log Out</a></li>
          </ul>
        </div>
      </div>
    </header>

    <div class="page-header">
      <div class="container">
        <h1>Bookings Management</h1>
        <p>View and manage all guest reservations in one place.</p>
      </div>
    </div>

    <main>
      <div class="container">
        <div class="bookings-container">
          <div class="bookings-header">
            <h2>All Bookings</h2>
            <div class="search-filter">
              <input
                type="text"
                id="search-input"
                placeholder="Search by name or email"
              />
              <button id="search-button">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
          </div>
          <table id="bookings-table">
            <thead>
              <tr>
                <th>Room Type</th>
                <th>Check-in Date</th>
                <th>Check-out Date</th>
                <th>Guests</th>
                <th>Nights</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Payment Method</th>
                <th>Special Requests</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Bookings will be populated here -->
            </tbody>
          </table>
          <div class="pagination" id="pagination">
            <!-- Pagination buttons will be dynamically added here -->
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="footer-content">
          <ul class="footer-links">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../aboutus.html">About Us</a></li>
            <li><a href="../privacy.html">Privacy Policy</a></li>
            <li><a href="../terms.html">Terms of Service</a></li>
            <li><a href="../contact.html">Contact Us</a></li>
          </ul>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin-in"></i></a>
          </div>
        </div>
        <div class="copyright">
          <p>&copy; 2025 MotelEase. All rights reserved.</p>
        </div>
      </div>

        <div id="edit-booking-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Booking</h2>
          <span class="close-btn">&times;</span>
        </div>
        <form id="edit-booking-form" class="modal-form">
          <input type="hidden" id="edit-booking-id">
          
          <div>
            <label for="edit-room-type">Room Type</label>
            <select id="edit-room-type" required>
              <option value="Standard">Standard</option>
              <option value="Deluxe">Deluxe</option>
              <option value="Suite">Suite</option>
              <option value="Family">Family</option>
            </select>
          </div>
          
          <div>
            <label for="edit-checkin-date">Check-in Date</label>
            <input type="date" id="edit-checkin-date" required>
          </div>
          
          <div>
            <label for="edit-checkout-date">Check-out Date</label>
            <input type="date" id="edit-checkout-date" required>
          </div>
          
          <div>
            <label for="edit-guests">Number of Guests</label>
            <input type="number" id="edit-guests" min="1" max="10" required>
          </div>
          
          <div>
            <label for="edit-first-name">First Name</label>
            <input type="text" id="edit-first-name" required>
          </div>
          
          <div>
            <label for="edit-last-name">Last Name</label>
            <input type="text" id="edit-last-name" required>
          </div>
          
          <div>
            <label for="edit-email">Email</label>
            <input type="email" id="edit-email" required>
          </div>
          
          <div>
            <label for="edit-phone">Phone</label>
            <input type="tel" id="edit-phone" required>
          </div>
          
          <div style="grid-column: 1 / -1;">
            <label for="edit-special-requests">Special Requests</label>
            <textarea id="edit-special-requests" rows="3" style="width: 100%; padding: 10px;"></textarea>
          </div>
        </form>
        <div class="modal-footer">
          <button class="cancel-btn" id="cancel-edit-btn">Cancel</button>
          <button class="save-btn" id="save-edit-btn">Save Changes</button>
        </div>
      </div>
    </div>
    </footer>

    <script>
      let currentPage = 1; // Track the current page
      let totalPages = 1; // Total number of pages
      let searchQuery = ""; // Track the search query
    
      // Function to fetch and display bookings
      async function fetchBookings(page = 1, search = "") {
        try {
          const response = await fetch(
            `/api/bookings?page=${page}&limit=5&search=${search}`
          );
          const data = await response.json();
    
          // Check if data.bookings exists and is an array
          if (!data.bookings || !Array.isArray(data.bookings)) {
            throw new Error("Invalid data format: bookings not found or not an array");
          }
    
          // Update the table with fetched bookings
          const tableBody = document.querySelector("#bookings-table tbody");
          tableBody.innerHTML = data.bookings
            .map((booking) => {
              return `
                <tr>
                  <td>${booking.roomType}</td>
                  <td>${new Date(booking.checkinDate).toLocaleDateString()}</td>
                  <td>${new Date(booking.checkoutDate).toLocaleDateString()}</td>
                  <td>${booking.guests}</td>
                  <td>${booking.nights}</td>
                  <td>${booking.firstName} ${booking.lastName}</td>
                  <td>${booking.email}</td>
                  <td>${booking.phone}</td>
                  <td>${booking.paymentMethod}</td>
                  <td>${booking.specialRequests || "None"}</td>
                   <td>
                    <div class="action-btns">
                      <button class="edit-btn" onclick="openEditModal('${booking._id}')">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
            })
            .join("");

    
          // Update pagination
          totalPages = data.totalPages || 1; // Default to 1 if totalPages is undefined
          updatePagination();
        } catch (error) {
          console.error("Error fetching bookings:", error);
          alert("Failed to fetch bookings. Please try again later.");
        }
      }

      // Function to open the edit modal
      async function openEditModal(bookingId) {
        const modal = document.getElementById('edit-booking-modal');
        const form = document.getElementById('edit-booking-form');
        
        try {
          // Fetch the specific booking details
          const response = await fetch(`/api/bookings/${bookingId}`);
          const booking = await response.json();
          
          // Populate the form with booking details
          document.getElementById('edit-booking-id').value = bookingId;
          document.getElementById('edit-room-type').value = booking.roomType;
          document.getElementById('edit-checkin-date').value = booking.checkinDate.split('T')[0];
          document.getElementById('edit-checkout-date').value = booking.checkoutDate.split('T')[0];
          document.getElementById('edit-guests').value = booking.guests;
          document.getElementById('edit-first-name').value = booking.firstName;
          document.getElementById('edit-last-name').value = booking.lastName;
          document.getElementById('edit-email').value = booking.email;
          document.getElementById('edit-phone').value = booking.phone;
          document.getElementById('edit-special-requests').value = booking.specialRequests || '';
          
          // Show the modal
          modal.style.display = 'block';
        } catch (error) {
          console.error("Error fetching booking details:", error);
          alert("Failed to load booking details. Please try again.");
        }
      }
    
      // Function to handle saving edited booking
      async function saveEditedBooking() {
        const bookingId = document.getElementById('edit-booking-id').value;
        
        // Prepare the updated booking data
        const updatedBooking = {
          roomType: document.getElementById('edit-room-type').value,
          checkinDate: document.getElementById('edit-checkin-date').value,
          checkoutDate: document.getElementById('edit-checkout-date').value,
          guests: document.getElementById('edit-guests').value,
          firstName: document.getElementById('edit-first-name').value,
          lastName: document.getElementById('edit-last-name').value,
          email: document.getElementById('edit-email').value,
          phone: document.getElementById('edit-phone').value,
          specialRequests: document.getElementById('edit-special-requests').value,
          // Calculate nights
          nights: Math.ceil((new Date(document.getElementById('edit-checkout-date').value) - 
                   new Date(document.getElementById('edit-checkin-date').value)) / (1000 * 60 * 60 * 24))
        };
        
        try {
          const response = await fetch(`/api/bookings/${bookingId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedBooking)
          });
          
          if (!response.ok) {
            throw new Error('Failed to update booking');
          }
          
          // Close the modal
          document.getElementById('edit-booking-modal').style.display = 'none';
          
          // Refresh the bookings list
          fetchBookings(currentPage, searchQuery);
          
          alert('Booking updated successfully!');
        } catch (error) {
          console.error("Error updating booking:", error);
          alert("Failed to update booking. Please try again.");
        }
      }
    
      // Function to update pagination buttons
      function updatePagination() {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";
    
        // Previous button
        const prevButton = document.createElement("button");
        prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            fetchBookings(currentPage, searchQuery);
          }
        });
        paginationDiv.appendChild(prevButton);
    
        // Page buttons
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          pageButton.className = currentPage === i ? "active" : "";
          pageButton.addEventListener("click", () => {
            currentPage = i;
            fetchBookings(currentPage, searchQuery);
          });
          paginationDiv.appendChild(pageButton);
        }
    
        // Next button
        const nextButton = document.createElement("button");
        nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            fetchBookings(currentPage, searchQuery);
          }
        });
        paginationDiv.appendChild(nextButton);
      }
    
      // Search functionality
      document.getElementById("search-button").addEventListener("click", () => {
        searchQuery = document.getElementById("search-input").value;
        currentPage = 1; // Reset to the first page when searching
        fetchBookings(currentPage, searchQuery);
      });

       // Modal event listeners
  const modal = document.getElementById('edit-booking-modal');
  const closeBtn = document.querySelector('.close-btn');
  const cancelBtn = document.getElementById('cancel-edit-btn');
  const saveBtn = document.getElementById('save-edit-btn');

  // Close modal when clicking 'x'
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }

  // Close modal when clicking Cancel button
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }

  // Save changes when clicking Save button
  if (saveBtn) {
    saveBtn.addEventListener('click', saveEditedBooking);
  }

    
      // Initial fetch of bookings when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        fetchBookings(currentPage, searchQuery);
      });
    </script>
  </body>
</html>
